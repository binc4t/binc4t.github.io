<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>
  学习 sentinel-golang 的滑动窗口实现 · where dream begins!
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="bincat">
<meta name="description" content="
  前言
  
    
    Link to heading
  

最近工作中需要用到限频的功能，限制同IP在一定时间内的访问量，又因为想做成统计周期可配置，所以令牌桶不太适用，需要用滑动窗口来实现，发现了一个专门做流量访问控制的阿里的开源项目sentinel，奈何自己太菜了，直接引用了其中的滑动窗口的实现，不过还是学习了人家的写法并记录在这里

  滑动窗口的基本属性
  
    
    Link to heading
  

滑动窗口有两个最基本的属性，长度以及分桶数；长度决定了这个窗口有多长，也就是统计周期；分桶数决定了这个窗口的统计颗粒度。
那么滑动窗口该怎么实现呢？
滑动窗口不断向前滚动，采用新的数据，抛弃旧的数据，就很容易让人联想到环形数组。都是不断淘汰旧的数据，每次关心的只有这个环的大小，更新的和更旧的数据都不关心。
一起看一下sentinel-golang中的滑动窗口实现吧

  sentinel-golang的滑动窗口实现
  
    
    Link to heading
  


  定义一个桶
  
    
    Link to heading
  

首先定义一个桶，最简单的桶就是一个counter，下面的MetricBucket就定义了一个桶，这里的counter是二维统计，可以将Pass, Reject, Total等维度分别统计，下面的minRT和maxConcurrency可以暂时不用关心， 可以看出一个桶本质上就是一个counter
type MetricBucket struct {
	// Value of statistic
	counter        [base.MetricEventTotal]int64
	minRt          int64
	maxConcurrency int32
}
通过面的函数可以对counter值做加法
func (mb *MetricBucket) addCount(event base.MetricEvent, count int64) {
	atomic.AddInt64(&amp;mb.counter[event], count)
}
上面的桶放之四海皆可，但是如果想成为个滑动窗口用桶，只有counter是不够的，因为滑动窗口中的每一个桶还有时间的概念，BucketWrap是对桶的封装，添加了开始时间BucketStart，Value中存放的是一个*MetricBucket
type BucketWrap struct {
	// BucketStart represents start timestamp of this statistic bucket wrapper.
	BucketStart uint64
	// Value represents the actual data structure of the metrics (e.g. MetricBucket).
	Value atomic.Value
}

  定义桶数组
  
    
    Link to heading
  

AtomicBucketWrapArray是一个环形数组的实现">
<meta name="keywords" content="">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="学习 sentinel-golang 的滑动窗口实现">
  <meta name="twitter:description" content="前言 Link to heading 最近工作中需要用到限频的功能，限制同IP在一定时间内的访问量，又因为想做成统计周期可配置，所以令牌桶不太适用，需要用滑动窗口来实现，发现了一个专门做流量访问控制的阿里的开源项目sentinel，奈何自己太菜了，直接引用了其中的滑动窗口的实现，不过还是学习了人家的写法并记录在这里
滑动窗口的基本属性 Link to heading 滑动窗口有两个最基本的属性，长度以及分桶数；长度决定了这个窗口有多长，也就是统计周期；分桶数决定了这个窗口的统计颗粒度。
那么滑动窗口该怎么实现呢？
滑动窗口不断向前滚动，采用新的数据，抛弃旧的数据，就很容易让人联想到环形数组。都是不断淘汰旧的数据，每次关心的只有这个环的大小，更新的和更旧的数据都不关心。
一起看一下sentinel-golang中的滑动窗口实现吧
sentinel-golang的滑动窗口实现 Link to heading 定义一个桶 Link to heading 首先定义一个桶，最简单的桶就是一个counter，下面的MetricBucket就定义了一个桶，这里的counter是二维统计，可以将Pass, Reject, Total等维度分别统计，下面的minRT和maxConcurrency可以暂时不用关心， 可以看出一个桶本质上就是一个counter
type MetricBucket struct { // Value of statistic counter [base.MetricEventTotal]int64 minRt int64 maxConcurrency int32 } 通过面的函数可以对counter值做加法
func (mb *MetricBucket) addCount(event base.MetricEvent, count int64) { atomic.AddInt64(&amp;mb.counter[event], count) } 上面的桶放之四海皆可，但是如果想成为个滑动窗口用桶，只有counter是不够的，因为滑动窗口中的每一个桶还有时间的概念，BucketWrap是对桶的封装，添加了开始时间BucketStart，Value中存放的是一个*MetricBucket
type BucketWrap struct { // BucketStart represents start timestamp of this statistic bucket wrapper. BucketStart uint64 // Value represents the actual data structure of the metrics (e.g. MetricBucket). Value atomic.Value } 定义桶数组 Link to heading AtomicBucketWrapArray是一个环形数组的实现">

<meta property="og:url" content="http://localhost:1313/posts/sentinel-golang_slidingwindow/">
  <meta property="og:site_name" content="where dream begins!">
  <meta property="og:title" content="学习 sentinel-golang 的滑动窗口实现">
  <meta property="og:description" content="前言 Link to heading 最近工作中需要用到限频的功能，限制同IP在一定时间内的访问量，又因为想做成统计周期可配置，所以令牌桶不太适用，需要用滑动窗口来实现，发现了一个专门做流量访问控制的阿里的开源项目sentinel，奈何自己太菜了，直接引用了其中的滑动窗口的实现，不过还是学习了人家的写法并记录在这里
滑动窗口的基本属性 Link to heading 滑动窗口有两个最基本的属性，长度以及分桶数；长度决定了这个窗口有多长，也就是统计周期；分桶数决定了这个窗口的统计颗粒度。
那么滑动窗口该怎么实现呢？
滑动窗口不断向前滚动，采用新的数据，抛弃旧的数据，就很容易让人联想到环形数组。都是不断淘汰旧的数据，每次关心的只有这个环的大小，更新的和更旧的数据都不关心。
一起看一下sentinel-golang中的滑动窗口实现吧
sentinel-golang的滑动窗口实现 Link to heading 定义一个桶 Link to heading 首先定义一个桶，最简单的桶就是一个counter，下面的MetricBucket就定义了一个桶，这里的counter是二维统计，可以将Pass, Reject, Total等维度分别统计，下面的minRT和maxConcurrency可以暂时不用关心， 可以看出一个桶本质上就是一个counter
type MetricBucket struct { // Value of statistic counter [base.MetricEventTotal]int64 minRt int64 maxConcurrency int32 } 通过面的函数可以对counter值做加法
func (mb *MetricBucket) addCount(event base.MetricEvent, count int64) { atomic.AddInt64(&amp;mb.counter[event], count) } 上面的桶放之四海皆可，但是如果想成为个滑动窗口用桶，只有counter是不够的，因为滑动窗口中的每一个桶还有时间的概念，BucketWrap是对桶的封装，添加了开始时间BucketStart，Value中存放的是一个*MetricBucket
type BucketWrap struct { // BucketStart represents start timestamp of this statistic bucket wrapper. BucketStart uint64 // Value represents the actual data structure of the metrics (e.g. MetricBucket). Value atomic.Value } 定义桶数组 Link to heading AtomicBucketWrapArray是一个环形数组的实现">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2023-09-03T10:06:39+08:00">
    <meta property="article:modified_time" content="2023-09-03T10:06:39+08:00">




<link rel="canonical" href="http://localhost:1313/posts/sentinel-golang_slidingwindow/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.css" media="screen">








 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>




<body class="preload-transitions colorscheme-light">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="http://localhost:1313/">
      where dream begins!
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/reading">Reading</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://localhost:1313/posts/sentinel-golang_slidingwindow/">
              学习 sentinel-golang 的滑动窗口实现
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2023-09-03T10:06:39&#43;08:00">
                September 3, 2023
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              6-minute read
            </span>
          </div>
          
          
          
        </div>
      </header>

      <div class="post-content">
        
        <h2 id="前言">
  前言
  <a class="heading-link" href="#%e5%89%8d%e8%a8%80">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>最近工作中需要用到限频的功能，限制同IP在一定时间内的访问量，又因为想做成统计周期可配置，所以令牌桶不太适用，需要用滑动窗口来实现，发现了一个专门做流量访问控制的阿里的开源项目<a href="link:https://github.com/alibaba/sentinel-golang" ><strong>sentinel</strong></a>，奈何自己太菜了，直接引用了其中的滑动窗口的实现，不过还是学习了人家的写法并记录在这里</p>
<h2 id="滑动窗口的基本属性">
  滑动窗口的基本属性
  <a class="heading-link" href="#%e6%bb%91%e5%8a%a8%e7%aa%97%e5%8f%a3%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%b1%9e%e6%80%a7">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>滑动窗口有两个最基本的属性，长度以及分桶数；长度决定了这个窗口有多长，也就是统计周期；分桶数决定了这个窗口的统计颗粒度。</p>
<p>那么滑动窗口该怎么实现呢？</p>
<p>滑动窗口不断向前滚动，采用新的数据，抛弃旧的数据，就很容易让人联想到环形数组。都是不断淘汰旧的数据，每次关心的只有这个环的大小，更新的和更旧的数据都不关心。</p>
<p>一起看一下sentinel-golang中的滑动窗口实现吧</p>
<h2 id="sentinel-golang的滑动窗口实现">
  sentinel-golang的滑动窗口实现
  <a class="heading-link" href="#sentinel-golang%e7%9a%84%e6%bb%91%e5%8a%a8%e7%aa%97%e5%8f%a3%e5%ae%9e%e7%8e%b0">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="定义一个桶">
  定义一个桶
  <a class="heading-link" href="#%e5%ae%9a%e4%b9%89%e4%b8%80%e4%b8%aa%e6%a1%b6">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>首先定义一个桶，最简单的桶就是一个counter，下面的<code>MetricBucket</code>就定义了一个桶，这里的counter是二维统计，可以将Pass, Reject, Total等维度分别统计，下面的<code>minRT</code>和<code>maxConcurrency</code>可以暂时不用关心， 可以看出一个桶本质上就是一个counter</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">MetricBucket</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">// Value of statistic</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">counter</span>        <span style="color:#1f2328">[</span><span style="color:#1f2328">base</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MetricEventTotal</span><span style="color:#1f2328">]</span><span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">minRt</span>          <span style="color:#cf222e">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">maxConcurrency</span> <span style="color:#cf222e">int32</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>通过面的函数可以对counter值做加法</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">mb</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">MetricBucket</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">addCount</span><span style="color:#1f2328">(</span><span style="color:#1f2328">event</span> <span style="color:#1f2328">base</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MetricEvent</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">count</span> <span style="color:#cf222e">int64</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">AddInt64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">mb</span><span style="color:#1f2328">.</span><span style="color:#1f2328">counter</span><span style="color:#1f2328">[</span><span style="color:#1f2328">event</span><span style="color:#1f2328">],</span> <span style="color:#1f2328">count</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>上面的桶放之四海皆可，但是如果想成为个滑动窗口用桶，只有counter是不够的，因为滑动窗口中的每一个桶还有时间的概念，BucketWrap是对桶的封装，添加了开始时间<code>BucketStart</code>，Value中存放的是一个<code>*MetricBucket</code></p>
<pre tabindex="0"><code>type BucketWrap struct {
	// BucketStart represents start timestamp of this statistic bucket wrapper.
	BucketStart uint64
	// Value represents the actual data structure of the metrics (e.g. MetricBucket).
	Value atomic.Value
}
</code></pre><h3 id="定义桶数组">
  定义桶数组
  <a class="heading-link" href="#%e5%ae%9a%e4%b9%89%e6%a1%b6%e6%95%b0%e7%bb%84">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p><code>AtomicBucketWrapArray</code>是一个环形数组的实现</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#57606a">// AtomicBucketWrapArray represents a thread-safe circular array.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// The length of the array should be provided on-create and cannot be modified.</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">AtomicBucketWrapArray</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">// The base address for real data array</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">base</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">// The length of slice(array), it can not be modified.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">length</span> <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">data</span>   <span style="color:#1f2328">[]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">BucketWrap</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p><code>LeapArray</code>则是在环形数组的基础上加入了滑动窗口的三个属性，桶长度、分桶数、滑动窗口总长度，使环形数组成为一个滑动窗口，这个是滑动窗口的核心结构</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#57606a">// LeapArray represents the fundamental implementation of a sliding window data-structure.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Some important attributes: the sampleCount represents the number of buckets,</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// while intervalInMs represents the total time span of the sliding window.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// For example, assuming sampleCount=5, intervalInMs is 1000ms, so the bucketLength is 200ms.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Let&#39;s give a diagram to illustrate.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// Suppose current timestamp is 1188, bucketLength is 200ms, intervalInMs is 1000ms, then</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// time span of current bucket is [1000, 1200). The representation of the underlying structure:</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//	 B0       B1      B2     B3      B4</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//	 |_______|_______|_______|_______|_______|</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//	1000    1200    400     600     800    (1000) ms</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//	       ^</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">//	    time=1188</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">LeapArray</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">bucketLengthInMs</span> <span style="color:#cf222e">uint32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">// sampleCount represents the number of BucketWrap.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">sampleCount</span> <span style="color:#cf222e">uint32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">// intervalInMs represents the total time span of the sliding window (in milliseconds).</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">intervalInMs</span> <span style="color:#cf222e">uint32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">// array represents the internal circular array.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">array</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">AtomicBucketWrapArray</span>
</span></span><span style="display:flex;"><span>	<span style="color:#57606a">// updateLock is the internal lock for update operations.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">updateLock</span> <span style="color:#1f2328">mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h3 id="关键函数">
  关键函数
  <a class="heading-link" href="#%e5%85%b3%e9%94%ae%e5%87%bd%e6%95%b0">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>对于滑动窗口来说，最重要的两件事情，一个是计数器+1，一个是获得窗口内所有分桶的统计和，下面分别介绍</p>
<h4 id="计数器1">
  计数器+1
  <a class="heading-link" href="#%e8%ae%a1%e6%95%b0%e5%99%a81">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>计数器+1可以分解成下面两件事情</p>
<ul>
<li>根据当前时间找到对应的桶</li>
<li>对这个桶的计数器+1
下面的函数也清楚的描述了这两个步骤</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">bla</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">BucketLeapArray</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">addCountWithTime</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">event</span> <span style="color:#1f2328">base</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MetricEvent</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">count</span> <span style="color:#cf222e">int64</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">b</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">bla</span><span style="color:#1f2328">.</span><span style="color:#6639ba">currentBucketWithTime</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span><span style="color:#1f2328">)</span> <span style="color:#57606a">// 根据当前时间找到对应的桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">b</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">b</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Add</span><span style="color:#1f2328">(</span><span style="color:#1f2328">event</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">count</span><span style="color:#1f2328">)</span> <span style="color:#57606a">// 对这个桶的计数器做加法</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>根据当前时间找到对应的桶</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">la</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LeapArray</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">currentBucketOfTime</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bg</span> <span style="color:#1f2328">BucketGenerator</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">BucketWrap</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">error</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">now</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Current time is less than 0.&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">idx</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#6639ba">calculateTimeIdx</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">bucketStart</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">calculateStartTime</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketLengthInMs</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span> <span style="color:#57606a">//spin to get the current BucketWrap</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">old</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">array</span><span style="color:#1f2328">.</span><span style="color:#6639ba">get</span><span style="color:#1f2328">(</span><span style="color:#1f2328">idx</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">old</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">// because la.array.data had initiated when new la.array</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">// theoretically, here is not reachable</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">newWrap</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">BucketWrap</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">BucketStart</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">bucketStart</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">Value</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Value</span><span style="color:#1f2328">{},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">newWrap</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Value</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">bg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewEmptyBucket</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">array</span><span style="color:#1f2328">.</span><span style="color:#6639ba">compareAndSet</span><span style="color:#1f2328">(</span><span style="color:#1f2328">idx</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">newWrap</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">return</span> <span style="color:#1f2328">newWrap</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">runtime</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Gosched</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#cf222e">if</span> <span style="color:#1f2328">bucketStart</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">old</span><span style="color:#1f2328">.</span><span style="color:#1f2328">BucketStart</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">return</span> <span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#cf222e">if</span> <span style="color:#1f2328">bucketStart</span> <span style="color:#1f2328">&gt;</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">old</span><span style="color:#1f2328">.</span><span style="color:#1f2328">BucketStart</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">// current time has been next cycle of LeapArray and LeapArray dont&#39;t count in last cycle.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">// reset BucketWrap</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">updateLock</span><span style="color:#1f2328">.</span><span style="color:#6639ba">TryLock</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">old</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">bg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ResetBucketTo</span><span style="color:#1f2328">(</span><span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketStart</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">updateLock</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Unlock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">return</span> <span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">runtime</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Gosched</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#cf222e">if</span> <span style="color:#1f2328">bucketStart</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">old</span><span style="color:#1f2328">.</span><span style="color:#1f2328">BucketStart</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">sampleCount</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">1</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">// if sampleCount==1 in leap array, in concurrency scenario, this case is possible</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">return</span> <span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">// TODO: reserve for some special case (e.g. when occupying &#34;future&#34; buckets).</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Provided time timeMillis=%d is already behind old.BucketStart=%d.&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketStart</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">old</span><span style="color:#1f2328">.</span><span style="color:#1f2328">BucketStart</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>先是通过下面两个函数确定桶在环形数组的idx，以及这个桶的起始时间应该是多少。</p>
<p>根据当前时间，算出对应的桶，在环形数组的那一个位置，这个是环形数组的经典的取模运算</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">la</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LeapArray</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">calculateTimeIdx</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">int</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">timeId</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">now</span> <span style="color:#0550ae">/</span> <span style="color:#6639ba">uint64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">bucketLengthInMs</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#6639ba">int</span><span style="color:#1f2328">(</span><span style="color:#1f2328">timeId</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">%</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">array</span><span style="color:#1f2328">.</span><span style="color:#1f2328">length</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>根据当前时间，算出对应分桶的开始时间是多少</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#6639ba">calculateStartTime</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketLengthInMs</span> <span style="color:#cf222e">uint32</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">uint64</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#1f2328">now</span> <span style="color:#0550ae">-</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">now</span> <span style="color:#0550ae">%</span> <span style="color:#6639ba">uint64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">bucketLengthInMs</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>这里为什么要算起始时间呢？<br>
因为环形数组上当前idx所在的桶，他不一定就是正确的桶，可能需要更新，比如在环形窗口最新和最旧桶的交接处，滑动窗口需要向前滑动一个桶的位置了，那么就需要淘汰最旧的桶，并将其数据清零。</p>
<p>接着是一个for循环</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span>	<span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span> <span style="color:#57606a">//spin to get the current BucketWrap</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">old</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">array</span><span style="color:#1f2328">.</span><span style="color:#6639ba">get</span><span style="color:#1f2328">(</span><span style="color:#1f2328">idx</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">old</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">// because la.array.data had initiated when new la.array</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">// theoretically, here is not reachable</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">newWrap</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">&amp;</span><span style="color:#1f2328">BucketWrap</span><span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">BucketStart</span><span style="color:#1f2328">:</span> <span style="color:#1f2328">bucketStart</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">Value</span><span style="color:#1f2328">:</span>       <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Value</span><span style="color:#1f2328">{},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">newWrap</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Value</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Store</span><span style="color:#1f2328">(</span><span style="color:#1f2328">bg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">NewEmptyBucket</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">array</span><span style="color:#1f2328">.</span><span style="color:#6639ba">compareAndSet</span><span style="color:#1f2328">(</span><span style="color:#1f2328">idx</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">newWrap</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">return</span> <span style="color:#1f2328">newWrap</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">runtime</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Gosched</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#cf222e">if</span> <span style="color:#1f2328">bucketStart</span> <span style="color:#0550ae">==</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">old</span><span style="color:#1f2328">.</span><span style="color:#1f2328">BucketStart</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">return</span> <span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#cf222e">if</span> <span style="color:#1f2328">bucketStart</span> <span style="color:#1f2328">&gt;</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">old</span><span style="color:#1f2328">.</span><span style="color:#1f2328">BucketStart</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">// current time has been next cycle of LeapArray and LeapArray dont&#39;t count in last cycle.</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">// reset BucketWrap</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">updateLock</span><span style="color:#1f2328">.</span><span style="color:#6639ba">TryLock</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">old</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">bg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ResetBucketTo</span><span style="color:#1f2328">(</span><span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketStart</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">updateLock</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Unlock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">return</span> <span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#1f2328">runtime</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Gosched</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#cf222e">if</span> <span style="color:#1f2328">bucketStart</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">old</span><span style="color:#1f2328">.</span><span style="color:#1f2328">BucketStart</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">if</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">sampleCount</span> <span style="color:#0550ae">==</span> <span style="color:#0550ae">1</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#57606a">// if sampleCount==1 in leap array, in concurrency scenario, this case is possible</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cf222e">return</span> <span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#57606a">// TODO: reserve for some special case (e.g. when occupying &#34;future&#34; buckets).</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">return</span> <span style="color:#cf222e">nil</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#1f2328">fmt</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Sprintf</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;Provided time timeMillis=%d is already behind old.BucketStart=%d.&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketStart</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">old</span><span style="color:#1f2328">.</span><span style="color:#1f2328">BucketStart</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>在for循环中，比较真实的startTime和环形数组上桶的startTime，有三种情况</p>
<ul>
<li>如果桶的startTime小了，就说明这个桶需要更新，调用<code>ResetBucketTo</code>对桶的startTime做更新，以及Reset所有数据；</li>
<li>如果相等，那么直接返回这个桶；</li>
<li>如果桶的startTime反而大，那么只有在并发情况下，且整个窗口只有一个分桶的时候才可能出现</li>
</ul>
<p>为什么只有一个分桶的时候才可能出现startTime大于实际值的情况呢？<br>
因为只有一个分桶的时候，无论怎么算idx，都是会返回idx=0，
假如starTime是t0，有前后两个时间，分别比t0稍大和稍小，并发下，比t0稍大的那个goroutine更新了这个桶，startTime变更了startTime+bucketLen，那么这时候比t0稍小的goroutine运行到这里就会到这个分枝</p>
<p>如果有至少两个分桶，那么上述的分别比t0稍大和稍小的两个请求一定会算到不同的桶上</p>
<p>注意在更新桶的时候用了这样的结构，这样可以在并发的时候，发现别的goroutine正在更新桶，那么就先让别人更新，让出线程，去调度到别的goroutine，这样自己继续for循环的时候就可以走到startTime相等的分支，直接返回即可了，也不会占用goroutine，等待锁的返回</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#cf222e">if</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">updateLock</span><span style="color:#1f2328">.</span><span style="color:#6639ba">TryLock</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">old</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">bg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ResetBucketTo</span><span style="color:#1f2328">(</span><span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketStart</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">updateLock</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Unlock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">runtime</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Gosched</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>找到对应桶后，对桶计数器+1，本质上是这样的函数</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">mb</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">MetricBucket</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">addCount</span><span style="color:#1f2328">(</span><span style="color:#1f2328">event</span> <span style="color:#1f2328">base</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MetricEvent</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">count</span> <span style="color:#cf222e">int64</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">AddInt64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">mb</span><span style="color:#1f2328">.</span><span style="color:#1f2328">counter</span><span style="color:#1f2328">[</span><span style="color:#1f2328">event</span><span style="color:#1f2328">],</span> <span style="color:#1f2328">count</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h4 id="获得窗口内所有分桶的统计和">
  获得窗口内所有分桶的统计和
  <a class="heading-link" href="#%e8%8e%b7%e5%be%97%e7%aa%97%e5%8f%a3%e5%86%85%e6%89%80%e6%9c%89%e5%88%86%e6%a1%b6%e7%9a%84%e7%bb%9f%e8%ae%a1%e5%92%8c">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>就像下面函数描述的那样，这个也分为两个步骤</p>
<ul>
<li>根据当前时间获取在有效时间范围内的所有桶</li>
<li>把这些桶的计数加起来</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">m</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SlidingWindowMetric</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">getSumWithTime</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">event</span> <span style="color:#1f2328">base</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MetricEvent</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">int64</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">satisfiedBuckets</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#6639ba">getSatisfiedBuckets</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span><span style="color:#1f2328">)</span> <span style="color:#57606a">// 根据当前时间获取在有效时间范围内的所有桶</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#6639ba">count</span><span style="color:#1f2328">(</span><span style="color:#1f2328">event</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">satisfiedBuckets</span><span style="color:#1f2328">)</span> <span style="color:#57606a">// 把这些桶的计数加起来</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>第一步获取在有效时间范围内的所有桶</p>
<ol>
<li>首先什么是有效时间范围</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#57606a">// getBucketStartRange returns start time range of the bucket for the provided time.</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// The actual time span is: [start, end + in.bucketTimeLength)</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">m</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SlidingWindowMetric</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">getBucketStartRange</span><span style="color:#1f2328">(</span><span style="color:#1f2328">timeMs</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">start</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">end</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">curBucketStartTime</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">calculateStartTime</span><span style="color:#1f2328">(</span><span style="color:#1f2328">timeMs</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">real</span><span style="color:#1f2328">.</span><span style="color:#6639ba">BucketLengthInMs</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">end</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">curBucketStartTime</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">start</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">end</span> <span style="color:#0550ae">-</span> <span style="color:#6639ba">uint64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">intervalInMs</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">+</span> <span style="color:#6639ba">uint64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">real</span><span style="color:#1f2328">.</span><span style="color:#6639ba">BucketLengthInMs</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><ol start="2">
<li>然后获取这个区间内的所有桶
通过下面的三层调用，把判断是否有效的方法传给下层，然后在<code>ValuesConditional</code>函数中遍历所有桶判断是否满足条件，非空、未过期且有效</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#1f2328">satisfiedBuckets</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">m</span><span style="color:#1f2328">.</span><span style="color:#1f2328">real</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ValuesConditional</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">func</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ws</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">ws</span> <span style="color:#0550ae">&gt;=</span> <span style="color:#1f2328">start</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#1f2328">ws</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#1f2328">end</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">bla</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">BucketLeapArray</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ValuesConditional</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">predicate</span> <span style="color:#1f2328">base</span><span style="color:#1f2328">.</span><span style="color:#1f2328">TimePredicate</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">[]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">BucketWrap</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#1f2328">bla</span><span style="color:#1f2328">.</span><span style="color:#1f2328">data</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ValuesConditional</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">predicate</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// ValuesConditional returns all buckets of which the startTimestamp satisfies the given timestamp condition (predicate).</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// The function uses the parameter &#34;now&#34; as the target timestamp.</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">la</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LeapArray</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">ValuesConditional</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">predicate</span> <span style="color:#1f2328">base</span><span style="color:#1f2328">.</span><span style="color:#1f2328">TimePredicate</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">[]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">BucketWrap</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">if</span> <span style="color:#1f2328">now</span> <span style="color:#0550ae">&lt;=</span> <span style="color:#0550ae">0</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">return</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">([]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">BucketWrap</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">ret</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">make</span><span style="color:#1f2328">([]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">BucketWrap</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">array</span><span style="color:#1f2328">.</span><span style="color:#1f2328">length</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">for</span> <span style="color:#1f2328">i</span> <span style="color:#0550ae">:=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span> <span style="color:#1f2328">&lt;</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">array</span><span style="color:#1f2328">.</span><span style="color:#1f2328">length</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">i</span><span style="color:#0550ae">++</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">ww</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">array</span><span style="color:#1f2328">.</span><span style="color:#6639ba">get</span><span style="color:#1f2328">(</span><span style="color:#1f2328">i</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">ww</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#6639ba">isBucketDeprecated</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ww</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">||</span> <span style="color:#1f2328">!</span><span style="color:#6639ba">predicate</span><span style="color:#1f2328">(</span><span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ww</span><span style="color:#1f2328">.</span><span style="color:#1f2328">BucketStart</span><span style="color:#1f2328">))</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">ret</span> <span style="color:#1f2328">=</span> <span style="color:#6639ba">append</span><span style="color:#1f2328">(</span><span style="color:#1f2328">ret</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ww</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#1f2328">ret</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">其中isBucketDeprecated定义如下</span><span style="color:#f6f8fa;background-color:#82071e">，</span><span style="color:#1f2328">即当前时间和桶的startTime的时间差不超过滑动窗口的长度</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// isBucketDeprecated checks whether the BucketWrap is expired, according to given timestamp.</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">la</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">LeapArray</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">isBucketDeprecated</span><span style="color:#1f2328">(</span><span style="color:#1f2328">now</span> <span style="color:#cf222e">uint64</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ww</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">BucketWrap</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">ws</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">LoadUint64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ww</span><span style="color:#1f2328">.</span><span style="color:#1f2328">BucketStart</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">now</span> <span style="color:#0550ae">-</span> <span style="color:#1f2328">ws</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">&gt;</span> <span style="color:#6639ba">uint64</span><span style="color:#1f2328">(</span><span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">intervalInMs</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>其实在这里case里predicate的条件已经能保证桶不过期了，但是这样写是为了通用吧，因为predicate可以传入任何方法</p>
<p>获取所有桶之后，对他们的数据相加得到结果</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">m</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">SlidingWindowMetric</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">count</span><span style="color:#1f2328">(</span><span style="color:#1f2328">event</span> <span style="color:#1f2328">base</span><span style="color:#1f2328">.</span><span style="color:#1f2328">MetricEvent</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">values</span> <span style="color:#1f2328">[]</span><span style="color:#0550ae">*</span><span style="color:#1f2328">BucketWrap</span><span style="color:#1f2328">)</span> <span style="color:#cf222e">int64</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">ret</span> <span style="color:#0550ae">:=</span> <span style="color:#6639ba">int64</span><span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">for</span> <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ww</span> <span style="color:#0550ae">:=</span> <span style="color:#cf222e">range</span> <span style="color:#1f2328">values</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">mb</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">ww</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Value</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Load</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">mb</span> <span style="color:#0550ae">==</span> <span style="color:#cf222e">nil</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">logging</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;nil BucketWrap&#34;</span><span style="color:#1f2328">),</span> <span style="color:#0a3069">&#34;Current bucket value is nil in SlidingWindowMetric.count()&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">counter</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">ok</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">mb</span><span style="color:#1f2328">.(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">MetricBucket</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#cf222e">if</span> <span style="color:#1f2328">!</span><span style="color:#1f2328">ok</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#1f2328">logging</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Error</span><span style="color:#1f2328">(</span><span style="color:#1f2328">errors</span><span style="color:#1f2328">.</span><span style="color:#6639ba">New</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;type assert failed&#34;</span><span style="color:#1f2328">),</span> <span style="color:#0a3069">&#34;Fail to do type assert in SlidingWindowMetric.count()&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;expectType&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;*MetricBucket&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;actualType&#34;</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">reflect</span><span style="color:#1f2328">.</span><span style="color:#6639ba">TypeOf</span><span style="color:#1f2328">(</span><span style="color:#1f2328">mb</span><span style="color:#1f2328">).</span><span style="color:#6639ba">Name</span><span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#cf222e">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#1f2328">ret</span> <span style="color:#0550ae">+=</span> <span style="color:#1f2328">counter</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Get</span><span style="color:#1f2328">(</span><span style="color:#1f2328">event</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#1f2328">ret</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h2 id="其他收获">
  其他收获
  <a class="heading-link" href="#%e5%85%b6%e4%bb%96%e6%94%b6%e8%8e%b7">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<h3 id="trylock和gosched的组合用法">
  <code>TryLock</code>和<code>Gosched</code>的组合用法
  <a class="heading-link" href="#trylock%e5%92%8cgosched%e7%9a%84%e7%bb%84%e5%90%88%e7%94%a8%e6%b3%95">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>检测到并发时，让其他goroutine获得调度，如果不是在这学到我可能自己怎么也想不到这样写。。。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#cf222e">for</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">updateLock</span><span style="color:#1f2328">.</span><span style="color:#6639ba">TryLock</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">old</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">bg</span><span style="color:#1f2328">.</span><span style="color:#6639ba">ResetBucketTo</span><span style="color:#1f2328">(</span><span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">bucketStart</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">la</span><span style="color:#1f2328">.</span><span style="color:#1f2328">updateLock</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Unlock</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">old</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span> <span style="color:#cf222e">else</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">runtime</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Gosched</span><span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">ohter</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">break</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/////////</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// tryLock的定义</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">const</span> <span style="color:#1f2328">mutexLocked</span> <span style="color:#1f2328">=</span> <span style="color:#0550ae">1</span> <span style="color:#0550ae">&lt;&lt;</span> <span style="color:#cf222e">iota</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// The mutex which supports try-locking.</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">mutex</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">sync</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// TryLock acquires the lock only if it is free at the time of invocation.</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">func</span> <span style="color:#1f2328">(</span><span style="color:#1f2328">tl</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">mutex</span><span style="color:#1f2328">)</span> <span style="color:#6639ba">TryLock</span><span style="color:#1f2328">()</span> <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#cf222e">return</span> <span style="color:#1f2328">atomic</span><span style="color:#1f2328">.</span><span style="color:#6639ba">CompareAndSwapInt32</span><span style="color:#1f2328">((</span><span style="color:#0550ae">*</span><span style="color:#cf222e">int32</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">tl</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Mutex</span><span style="color:#1f2328">)),</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#1f2328">mutexLocked</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><h3 id="unsafepointer用法">
  unsafe.Pointer用法
  <a class="heading-link" href="#unsafepointer%e7%94%a8%e6%b3%95">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>在初始化环形数组的时候用到了<code>*util.SliceHeader</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#1f2328">sliHeader</span> <span style="color:#0550ae">:=</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">*</span><span style="color:#1f2328">util</span><span style="color:#1f2328">.</span><span style="color:#1f2328">SliceHeader</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#1f2328">ret</span><span style="color:#1f2328">.</span><span style="color:#1f2328">data</span><span style="color:#1f2328">))</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">ret</span><span style="color:#1f2328">.</span><span style="color:#1f2328">base</span> <span style="color:#1f2328">=</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">((</span><span style="color:#0550ae">**</span><span style="color:#1f2328">BucketWrap</span><span style="color:#1f2328">)(</span><span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#6639ba">Pointer</span><span style="color:#1f2328">(</span><span style="color:#1f2328">sliHeader</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Data</span><span style="color:#1f2328">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">/////</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// SliceHeader 的定义</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">// SliceHeader is a safe version of SliceHeader used within this project.</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">type</span> <span style="color:#1f2328">SliceHeader</span> <span style="color:#cf222e">struct</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">Data</span> <span style="color:#1f2328">unsafe</span><span style="color:#1f2328">.</span><span style="color:#1f2328">Pointer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">Len</span>  <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#1f2328">Cap</span>  <span style="color:#cf222e">int</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span></code></pre></div><p>不知道为什么不可以直接这样</p>
<pre tabindex="0"><code>ret.base = unsafe.Pointer(sliHeader.Data))
</code></pre><p>这个问题在repo进行了提问。。 请戳 <a href="https://github.com/alibaba/sentinel-golang/issues/546"  class="external-link" target="_blank" rel="noopener">https://github.com/alibaba/sentinel-golang/issues/546</a><br>
以及对于第二行<code>(**BucketWrap)(unsafe.Pointer)</code>的转换也不是很懂</p>
<h2 id="总结">
  总结
  <a class="heading-link" href="#%e6%80%bb%e7%bb%93">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>通过环形数组实现滑动窗口，记住滑动窗口最终要的两个属性，长度和分桶数，它们决定了统计周期、粒度、滑动步长。以及最重要的两个方法：<code>AddCount</code>和<code>GetSum</code>。代码中关于<code>unsafe.Pointer</code>还有一些没彻底读懂的地方，下次继续学习吧！</p>

      </div>


      <footer>
        


        
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
    2025
     bincat 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.js"></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
