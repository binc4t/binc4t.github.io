<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="bincat"><meta name=description content="最近在给手机测试时，想要把手机上对特定域名的请求劫持到Mac上来，就需要用到dnsmasq，把Mac变成一个dns服务器，然后手机的dns服务器地址修改到mac上来。下面做一个配置备忘
参考：https://blog.niekun.net/archives/1869.html
省略安装步骤，debian用 apt install，mac用 brew install 即可，下面进行配置
dnsmasq会按照一定的顺序去进行域名解析
首先是系统以及自定义的hosts文件： /etc/hosts /etc/hosts.dnsmasq 然后是上游dns server，定义在：resolv.dnsmasq.conf 默认dns server记录在/etc/resolv.conf文件中，既然我们要使用dnsmasq来做dns服务器，那么就应该让dnsmasq能够查询系统原本的dns sever，等于是用dnsmasq做了一个中继
sudo cp /etc/resolv.conf /etc/resolv.dnsmasq.conf 然后在/etc/resolv.conf文件中，将内容改为
nameserver 127.0.0.1 这样就把本机的dns server指向了 127.0.0.1，这时候机器的dns请求就会发往127.0.0.1的53端口，dns默认监听端口，也是dnsmasq的监听端口
然后再在 /etc/dnsmasq.conf 文件中输入配置
# 监听地址： # 如果只写 127.0.0.1 则只处理本机的 DNS 解析，不写这句默认监听所有网口 # listen-address=127.0.0.1,192.168.8.132 # 指定自定义 hosts 文件： addn-hosts=/etc/hosts.dnsmasq # 指定上游 DNS 服务列表的配置文件 resolv-file=/etc/resolv.dnsmasq.conf # 按照 DNS 列表一个个查询，否则将请求发送到所有 DNS 服务器 strict-order # 表示对下面设置的所有 server 发起查询请求，选择响应最快的服务器的结果 all-servers 这样配置过程就完成了！
此时本机的dns请求的查询路径就会是
/etc/hosts -> dnsmasq 然后dnsmasq又会依次检索
/etc/hosts /etc/hosts.dnsmasq -> resolv."><meta name=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="dnsmasq 使用备忘"><meta name=twitter:description content="最近在给手机测试时，想要把手机上对特定域名的请求劫持到Mac上来，就需要用到dnsmasq，把Mac变成一个dns服务器，然后手机的dns服务器地址修改到mac上来。下面做一个配置备忘
参考：https://blog.niekun.net/archives/1869.html
省略安装步骤，debian用 apt install，mac用 brew install 即可，下面进行配置
dnsmasq会按照一定的顺序去进行域名解析
首先是系统以及自定义的hosts文件： /etc/hosts /etc/hosts.dnsmasq 然后是上游dns server，定义在：resolv.dnsmasq.conf 默认dns server记录在/etc/resolv.conf文件中，既然我们要使用dnsmasq来做dns服务器，那么就应该让dnsmasq能够查询系统原本的dns sever，等于是用dnsmasq做了一个中继
sudo cp /etc/resolv.conf /etc/resolv.dnsmasq.conf 然后在/etc/resolv.conf文件中，将内容改为
nameserver 127.0.0.1 这样就把本机的dns server指向了 127.0.0.1，这时候机器的dns请求就会发往127.0.0.1的53端口，dns默认监听端口，也是dnsmasq的监听端口
然后再在 /etc/dnsmasq.conf 文件中输入配置
# 监听地址： # 如果只写 127.0.0.1 则只处理本机的 DNS 解析，不写这句默认监听所有网口 # listen-address=127.0.0.1,192.168.8.132 # 指定自定义 hosts 文件： addn-hosts=/etc/hosts.dnsmasq # 指定上游 DNS 服务列表的配置文件 resolv-file=/etc/resolv.dnsmasq.conf # 按照 DNS 列表一个个查询，否则将请求发送到所有 DNS 服务器 strict-order # 表示对下面设置的所有 server 发起查询请求，选择响应最快的服务器的结果 all-servers 这样配置过程就完成了！
此时本机的dns请求的查询路径就会是
/etc/hosts -> dnsmasq 然后dnsmasq又会依次检索
/etc/hosts /etc/hosts.dnsmasq -> resolv."><meta property="og:title" content="dnsmasq 使用备忘"><meta property="og:description" content="最近在给手机测试时，想要把手机上对特定域名的请求劫持到Mac上来，就需要用到dnsmasq，把Mac变成一个dns服务器，然后手机的dns服务器地址修改到mac上来。下面做一个配置备忘
参考：https://blog.niekun.net/archives/1869.html
省略安装步骤，debian用 apt install，mac用 brew install 即可，下面进行配置
dnsmasq会按照一定的顺序去进行域名解析
首先是系统以及自定义的hosts文件： /etc/hosts /etc/hosts.dnsmasq 然后是上游dns server，定义在：resolv.dnsmasq.conf 默认dns server记录在/etc/resolv.conf文件中，既然我们要使用dnsmasq来做dns服务器，那么就应该让dnsmasq能够查询系统原本的dns sever，等于是用dnsmasq做了一个中继
sudo cp /etc/resolv.conf /etc/resolv.dnsmasq.conf 然后在/etc/resolv.conf文件中，将内容改为
nameserver 127.0.0.1 这样就把本机的dns server指向了 127.0.0.1，这时候机器的dns请求就会发往127.0.0.1的53端口，dns默认监听端口，也是dnsmasq的监听端口
然后再在 /etc/dnsmasq.conf 文件中输入配置
# 监听地址： # 如果只写 127.0.0.1 则只处理本机的 DNS 解析，不写这句默认监听所有网口 # listen-address=127.0.0.1,192.168.8.132 # 指定自定义 hosts 文件： addn-hosts=/etc/hosts.dnsmasq # 指定上游 DNS 服务列表的配置文件 resolv-file=/etc/resolv.dnsmasq.conf # 按照 DNS 列表一个个查询，否则将请求发送到所有 DNS 服务器 strict-order # 表示对下面设置的所有 server 发起查询请求，选择响应最快的服务器的结果 all-servers 这样配置过程就完成了！
此时本机的dns请求的查询路径就会是
/etc/hosts -> dnsmasq 然后dnsmasq又会依次检索
/etc/hosts /etc/hosts.dnsmasq -> resolv."><meta property="og:type" content="article"><meta property="og:url" content="https://binc4t.github.io/posts/dnsmasq/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-12T23:04:41+08:00"><meta property="article:modified_time" content="2024-01-12T23:04:41+08:00"><title>dnsmasq 使用备忘 · where dream begins!
</title><link rel=canonical href=https://binc4t.github.io/posts/dnsmasq/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><meta name=generator content="Hugo 0.121.2"></head><body class="preload-transitions colorscheme-light"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>where dream begins!
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/reading>Reading</a></li><li class=navigation-item><a class=navigation-link href=/about>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://binc4t.github.io/posts/dnsmasq/>dnsmasq 使用备忘</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-01-12T23:04:41+08:00>January 12, 2024
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
One-minute read</span></div></div></header><div><p>最近在给手机测试时，想要把手机上对特定域名的请求劫持到Mac上来，就需要用到dnsmasq，把Mac变成一个dns服务器，然后手机的dns服务器地址修改到mac上来。下面做一个配置备忘</p><p>参考：https://blog.niekun.net/archives/1869.html</p><p>省略安装步骤，debian用 <code>apt install</code>，mac用 <code>brew install</code> 即可，下面进行配置</p><p>dnsmasq会按照一定的顺序去进行域名解析</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>首先是系统以及自定义的hosts文件： /etc/hosts  /etc/hosts.dnsmasq
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>然后是上游dns server，定义在：resolv.dnsmasq.conf 
</span></span></code></pre></div><p>默认dns server记录在<code>/etc/resolv.conf</code>文件中，既然我们要使用dnsmasq来做dns服务器，那么就应该让dnsmasq能够查询系统原本的dns sever，等于是用dnsmasq做了一个中继</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cp /etc/resolv.conf /etc/resolv.dnsmasq.conf
</span></span></code></pre></div><p>然后在/etc/resolv.conf文件中，将内容改为</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nameserver 127.0.0.1
</span></span></code></pre></div><p>这样就把本机的dns server指向了 127.0.0.1，这时候机器的dns请求就会发往127.0.0.1的53端口，dns默认监听端口，也是dnsmasq的监听端口</p><p>然后再在 <code>/etc/dnsmasq.conf</code> 文件中输入配置</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#998;font-style:italic># 监听地址：</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># 如果只写 127.0.0.1 则只处理本机的 DNS 解析，不写这句默认监听所有网口</span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># listen-address=127.0.0.1,192.168.8.132</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># 指定自定义 hosts 文件：</span>
</span></span><span style=display:flex><span>addn-hosts<span style=color:#000;font-weight:700>=</span>/etc/hosts.dnsmasq
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># 指定上游 DNS 服务列表的配置文件</span>
</span></span><span style=display:flex><span>resolv-file<span style=color:#000;font-weight:700>=</span>/etc/resolv.dnsmasq.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># 按照 DNS 列表一个个查询，否则将请求发送到所有 DNS 服务器</span>
</span></span><span style=display:flex><span>strict-order
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#998;font-style:italic># 表示对下面设置的所有 server 发起查询请求，选择响应最快的服务器的结果</span>
</span></span><span style=display:flex><span>all-servers
</span></span></code></pre></div><p>这样配置过程就完成了！</p><p>此时本机的dns请求的查询路径就会是</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/etc/hosts -&gt; dnsmasq
</span></span></code></pre></div><p>然后dnsmasq又会依次检索</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>/etc/hosts  /etc/hosts.dnsmasq -&gt; resolv.dnsmasq.conf
</span></span></code></pre></div><p>那么此时我们在 <code>/etc/hosts</code> 或者 <code>/etc/hosts.dnsmasq</code> 文件中定义一条 host，就可以改变dns解析的结果</p><p>不仅是本机的dns查询，因为dnsmasq监听53端口，相当于本机也是一个dns服务器，其他服务器可以向本机进行dns查询，或者把dns服务器地址设置成本机，这在进行手机的dns劫持时很有用处</p></div><footer></footer></article></section></div><footer class=footer><section class=container>©
2024
bincat
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.9cf2dbf9b6989ef8eae941ffb4231c26d1dc026bca38f1d19fdba50177d8a9ac.js integrity="sha256-nPLb+baYnvjq6UH/tCMcJtHcAmvKOPHRn9ulAXfYqaw="></script></body></html>